# 1. 控制器概述
## 1.1. 控制器的功能
- 取指令
- 分析指令
- 执行指令，发出各种操作命令
- 总线管理
- 处理中断、异常等特殊情况

![](./images/CPU的结构.png)  

## 1.2. 指令周期
**计算机读取并执行完一条指令的全部时间，称为指令周期**

指令周期大体可以分成四个阶段
- 取指周期: 从内存中取得指令，并分析指令。
- 间址周期: **间接寻址**的指令都包含间址周期。发出指令中的形式地址，从内存中读回有效地址。
- 执行周期: 除空操作以及 NOP 指令外，所有指令都包括执行周期，用以完成指令的主要功能。
- 中断周期: 如果在前面三个过程中有设备发出了中断请求，则在执行完上述三个周期后，执行中断隐指令

**注意**：并不是每一条指令都包括完整的四个阶段

## 1.3. 机器周期
**指令执行的每个阶段，称为一个机器周期，也称为工作周期**

##### 如何确定机器周期的长度
- 每条指令的执行步骤
- 每一步骤所需的时间
- 以完成最复杂、最慢指令功能的时间为准
##### 统一机器周期的确定
- 计算机中，最慢指令为访存指令，因此**以一次访存所需时间作为机器周期**
- 若“指令字长=存储字长”，则“访存周期=机器周期”
## 1.4. 时钟周期
- **将一个机器周期分为若干个时间相等的时间段，每段称为一个时钟周期**。（节拍、状态）
- 时钟周期是控制计算机操作的最小时间单位
- 用时钟周期控制微操作命令，每个时钟周期产生一个或几个微操作命令
常用$T_0$，$T_1$，$T_2$，$T_3$来描述时钟周期

##### 时钟周期的产生方法
使用计数器和译码器来控制每次执行的微操作

![](./images/时钟周期与机器周期.png)

## 1.5. 指令周期、机器周期和时钟周期的关系
指令周期、机器周期、时钟周期（节拍、状态）组成多级（三级）时序系统

一个机器周期内包含若干时钟周期，包含时钟周期的个数称之为机器周期的时间宽度。

如果每个机器周期的时间宽度相等，称为**定长机器周期**；如果不相等，称为变长机器周期。

![](./images/指令周期、机器周期、时钟周期的关系.png)

# 2. 指令周期的操作命令分析
## 2.1. 取指周期
* PC保存了下一条指令在内存单元的地址，PC -> MAR -> 地址总线
* 控制器发出一条存储器读命令，存储器将该地址存放的数据放到数据总线上，并锁存到MDR
* MDR -> IR
* PC+1 -> PC

![](./images/取指周期数据通路.png) 

## 2.2. 间址周期
取指周期结束后，控制器检查IR内容，确定是否需要一个使用间接寻址的操作数指定器，若需要，一个间址周期被执行

* 将指令中的地址部分送到MAR ： Ad(IR) -> MAR
* 控制器发出一条存储器读命令
* 存储器将该地址存放的数据放到地址线上，并锁存到MDR
* 将数据写回到指令的地址部分 ： MDR -> Ad(IR)

![](./images/间址周期数据通路.png)

## 2.3. 执行周期
#### 非访存指令
指令的执行阶段，都不会访存到存储器
* CLA：清零指令，微操作是 0 -> ACC，将累加器清0
* COM：取反指令，微操作是将累加器内容按位取反
* SHR：算术右移
* CSL：循环左移
* STP：停机指令，微操作是 0 -> G，一旦控制信号有效，机器就会停止
#### 访存指令
##### 加法指令（ADD X）
* 将指令的地址部分送到 MAR：Ad(IR) -> MAR
* 控制器发出一条存储器读命令
* 将加法所需数据从内存读出：M(MAR) -> MDR
* 与ACC寄存器中的数据相加，结果保存到ACC寄存器：(ACC) + (MDR) -> ACC

##### 存数指令（STA X）
* 将指令的地址部分送到MAR：Ad(IR) -> MAR
* 控制器发出一条存储器写命令
* 控制器将待写的数据（ACC中）放入MDR：ACC -> MDR
* 将MDR上的数据写入主存中MAR寄存器所指定的内存位置上：MDR -> M(MAR)

##### 取数指令（LDA X）
* 将指令的地址部分送到MAR：Ad(IR) -> MAR
* 控制器发出一条存储器读命令
* 从存储器中MAR所指定的内存位置上读出数据，放到MDR
* 将数据写入累加器：MDR -> ACC

##### 无条件转移指令 （JMP X）
* 将跳转地址赋给PC ： Ad(IR) -> PC

## 2.4. 中断周期
1. 保存断点
中断隐指令中需要保存断点，通常断点都保存在内存的 0 号单元中。

    * CU 传 0 到 MAR，作为断点保存地址
    * 控制器发出一条存储器写命令
    * 将即将要执行的指令地址送到 MDR，PC 中的内容就是断点： PC -> MDR
    * 将断点写入内存中：MDR -> M(MAR)

2. 执行中断处理程序（PC跳转）
    * 中断向量地址 -> PC

3. 硬件关中断
    * 将中断总允许位置0： 0 -> EINT

# 3. 流水线技术
将一个重复的过程分解成若干子过程，每个子过程与其他子过程并行执行。由于流水线技术只需增加少量硬件就能把计算机运行速度提高几倍，故而广泛用于并行处理

![](./images/流水线技术.png)

#### 流水线的主要特点：
* 流水过程由多个相联系的流水段组成，每个流水段称为流水线的“级”或“段”，流水线的段数也称为流水线的**深度**或**流水深度**，每个流水段由专用的功能部件实现
* 每个功能段所需时间应尽量相等，否则时间长的功能段将成为流水线的瓶颈，会造成**流水线堵塞或断流**，这个时间一般为一个时钟周期或机器周期
* 流水线需要有**通过时间**（第一个任务流出结果所需的时间），在此之后，流水过程才进入稳定工作状态，每一个时钟周期流出一个结果
* 流水技术适合于大量重复的时序过程，只有输入端能连续地提供任务，流水线的效率才能充分发挥


