# 1. LLVM概览
LLVM在编译不同阶段会采用不同的数据结构：
![LLVM IR](/Picture/08.LLVM%20IR.png)

# 2. LLVM基本理念
LLVM IR作为一种编译器IR，它的两个基本原则指导着核心库的开发：
- SSA表示，代码组织为三地址指令序列和无限寄存器让优化能够快速执行
- 整个程序的IR存储到磁盘，让链接时优化易于实现
## 2.1 静态单赋值（SSA，Static Single Assignment）
当程序中每个变量有且仅有一个赋值语句时，称一个程序是静态单赋值形式的。LLVM IR中，**每个变量在使用前都必须先定义，且每个变量只能被赋值一次**。以```1*2+3```为例：
```
%0 = mul i32 1, 2
%0 = add i32 %0, 3
ret i32 %0
```
```
%0 = mul i32 1, 2
%1 = add i32 %0, 3
ret i32 %1
```
每个值只有单一赋值定义了它。每次使用一个值，可以立刻向后追溯到给出其定义的唯一的指令。极大简化优化，因为SSA形式建立了平凡的use-def链，也就是一个值到达使用之处的定义的列表。
## 2.1.1 静态单赋值的好处
```
d1: y := 1
一些无关代码
d2: y := 2
一些无关代码
d3: x := y
```
可以看暗处，第一次对y的赋值时不必要的，在对x赋值时，使用的y的值是第二次赋值的结果，但是编译器必须要经过一个**定义可达性**（Reaching Definition）分析才能做出判断。
# 2.1.2 几个基本概念
- **定义**：对变量 x 进行定义的意思是在某处会/可能给 x 进行赋值，比如上面的 d1 处就是一个对 y 的定义。
- **kill**：当一个变量有了新的定义后，旧有的定义就会被 kill，在上面的语句中 d2 就 kill 了 d1 中对 y 的定义
- **定义到达某点**：定义 p 到达某点 q 的意思是存在一条路径，沿着这条路径行进，p 在到达到点 q 之前不会被 kill。
- **reaching definition**：a 是 b 的 reaching definition 的意思是存在一条从 a 到达 b 的路径，沿着这条路径走可以自然得到 a 要赋值的变量的值，而不需要额外的信息。

按照上面的写法，d1不再是d3的 reaching definition, 因为d2使它不再可能被到达。

如果控制流再复杂一点，对于编译器来说，它无法确切知道d3的 reaching definition是d1或者d2了，也不清楚d1和d2到底是谁kill了谁。但是，如果我们的代码是 SSA 形式的，那它就会长成这样。
```
d1: y1 := 1
一些无关代码
d2: y2 := 2
一些无关代码
d3: x := y2
```
编译器很容易就能够发现x是由 y2 赋值得到，而 y2 被赋值了 2，且 x 和 y2 都只能被赋值一次，显然得到 x 的值的路径就是唯一确定的，d2 就是 d3 的 reaching definition。而这样的信息，在编译器想要进行优化时会起到很大的作用。
## 2.2. LLVM IR基本语法
- LLVM IR是类似于精简指令集（RISC）的底层虚拟指令集
- 和真实精简指令集一样，支持简单指令的线性序列，如加减比较和分支
- 指令都是三地址形式，它们接受一定数量的输入，然后在不同的寄存器中存储计算结果
- LLVM使用强类型的简单类型系统，并剥离了机器差异
- LLVM IR不使用固定的命名寄存器，它使用以%字符命名的临时寄存器
## 2.3. 三地址码
每个三地址码指令，都可以被分解为一个四元组的形式：**（运算符，操作数1，操作数2，结果）**，由于每个陈述都包含了3个变量，即每条指令最多有三个操作数，所以被称为三地址码。  
| 指令类型 | 指令形式 | 四元组表示 |
|:---------:|:--------:|:----------:|
|赋值指令|z=x op y (z = x+y)|(op,x,y,z)
## 2.4. LLVM IR表示形式
LLVM IR具有三种表示形式，这三种中间格式是完全等价的：
- 在内存中的编译中间语言（无法通过文件的形式得到的指令类等）
- 在硬盘上存储的二进制中间语言（格式为.bc）
- 人类刻度的代码语言（格式为.ll）
## 2.5. LLVM IR内存模型
- LLVM IR文件的基本单位称为**module**
- 一个module中可以拥有多个顶层实体，比如function和global variable
- 一个function define中至少有一个basicblock
- 每个basicblock中有若干instruction，并且都以terminator instruction结尾
LLVM IR内存模型最重要的概念：Value，Use，User
