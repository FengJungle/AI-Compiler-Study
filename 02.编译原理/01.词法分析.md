# 0. 词法分析器的作用
词法分析是编译的第一阶段，主要任务是
- **读入源程序的输入字符，将它们组成词素，生成并输出一个词法单元序列**。这个词法单元序列被输出给语法分析器进行语法分析。  
- 过滤掉源程序中的注释和空白
- 将编译器生成的错误信息与源程序的位置关联起来。
# 1. 词法单元、模式和词素
## 1.1. 词法单元
- **词法单元由词法单元名和可选的属性值组成**。词法单元名是一个词法单元的引用（别名），它将作为语法分析器处理的输入符号。当有多个词素的词法单元名相同时，可以附加属性值信息来区别这些词素。词法单元名将影响语法分析过程中的决定，而属性值将影响语法分析之后对这个词法单元的翻译（具体翻译成哪一个词素）
- 模式描述一个词法单元的词素可能具有的形式
- 词素是一个字符序列（串），它和某个词法单元的模式匹配，并被词法分析器识别为该词法单元的一个实例

|词法单元名|属性值|模式（非正式描述）|词素（举例）|
|:----:|:---:|:---:|:---:|
|id|指针|以字母开头的数字/字母序列|foo, PI, d2|
|literal|指针|在两个"之间的任何字符序列|"hello world"|
|number|具体数字|任何数字常量|1,0.5,1.9e-10|

## 1.2. 词法单元的规约
每个词法单元都有一个模式来描述它的所有词素，**正则表达式**正是这样一种用来描述词素模式的重要方法。在真正介绍正则表达式之前，我们还需要了解**串**和**语言**以及一些相关的术语和运算，这些内容能帮助我们十分容易地理解正则表达式。
### 串
某个符号集合上的一个串是该集合中符号的一个有穷序列。这句话说明了串的两个特点：
* 组成串的符号都来自某个符号集合
* 串的长度是可数的。举个例子：对集合A={a，b，…，z，A，B，…，Z}来说，它的一个串只能包括大小写字母，并且长度是可数的。
下面定义了一些串相关的术语：

|术语|说明|
|:--:|:--:|
|长度|串s的长度是指组成串的符号的个数，即为|s||
|空串|长度为0的串，用ε表示|
|前缀（prefix）|串s的前缀是从s的尾部删除0个或多个符号后得到的串|
|后缀（suffix）|串s的后缀是从s的头部删除0个或多个符号后得到的串|
|子串（substring）|串s的子串是删除s的某个前缀和/或某个后缀之后得到的串|
|子序列（subsequence）|串s的子序列是从s中删除0个或多个符号后得到的串，这些被删除的符号可能不相邻，字串的子序列的区别就在于此|
|真前缀/真后缀/真子串|串s的真前缀/真后缀/真子串是既不等于s也不等于s的前缀/后缀/子串|

### 语言
语言是某个给定的符号集合上一个任意的可数的串集合。
- 首先，语言是一个集合
- 其次，这个集合中的元素是串，并且集合的大小是任意的
- 最后，这些串是依据某个符号集合生成的
下面定义了语言上的运算：  
![语言上的运算](./Picture/03.%E8%AF%AD%E8%A8%80%E8%BF%90%E7%AE%97%E7%9A%84%E5%AE%9A%E4%B9%89.png)
### 正则表达式
正则表达式可以用来描述词素的模式，一个正则表达式可以由较小的正则表达式递归的构建。每个正则表达式r表示一个语言L(r)，这个语言也是根据r的子表达式所表示的语言递归地定义的。下面的规则定义了某个字母表Σ上的正则表达式以及这些表达式所表示的语言。
#### 归纳基础：
- ε是一个正则表达式，L(ε) = {ε}，即该语言只包含空串
- 如果a是Σ上的一个符号，那么a是一个正则表达式，并且L(a) = {a}。也就是说，这个语言仅包含一个长度为1的符号串a。
#### 归纳步骤：
由小的正则表达式构造较大的正则表达式的步骤有四个部分。假定r和s都是正则表达式，分别表示语言L(r)和L(s)，那么：
- (r)|(s)是一个正则表达式，表示语言L(r)∪L(s)
- (r)(s)是一个正则表达式，表示语言L(r)L(s)
- (r)*是一个正则表达式，表示语言(L(r)) *
- (r)是一个正则表达式，表示语言L(r)

**注意**： 优先级
- 一元运算符*具有最高的优先级，并且是**左结合**的
- 连接具有次高的优先级，也是左结合的
- | 的优先级最低，也是左结合的

下面我们举例说明。对于符号集合∑={a，b}，有：
- 正则表达式a表示语言{a}
- 正则表达式a|b表示语言{a，b}
- 正则表达式(a|b)(a|b)表示语言{aa，ab，ba，bb}
- 正则表达式a*表示语言{ε，a，aa，aaa，…}
- 正则表达式(a|b)*表示语言{ε，a，b，aa，ab，ba，bb，aaa，…}
- 正则表达式a|a*b表示语言{a，b，ab，aab，aaab，…}

## 1.3. 词法单元的识别
上面介绍了如何用正则表达式来表示一个模式，下面将介绍如何根据词法单元的模式来识别一个与该模式匹配的词素，为此，我们首先将模式转换成状态转换图。

一个状态转换图由一组表示状态的结点和表示输入字符的边构成，词法分析器在扫描输入字符串的过程中寻找和某个模式匹配的词素，状态转换图中的每个状态代表一个可能在这个过程中出现的情况。一个状态转换图有如下特点：
- 有一个初始状态，该状态由一条无出发结点的、标号为“start”的边指明。在读入任何输入符号之前，状态转换图总位于它的初始状态；
- 有某些最终状态，该状态用双层的圈表示。这些状态表明已经找到一个词素；
- 有某些回退状态，该状态附近有一个“*”标明。在识别“3+4”这个串时，只有当扫描到“+”符号时，才能确定前面的数字符号“3”，此时识别出了词素“3”，并且需要回退一个字符。

# 2. 有穷自动机
有穷自动机（Finite Automata，FA）是对一类处理系统建立的数学模型。这类系统具有一系列**离散的输入输出信息**和**有穷数目的内部状态**（状态：概括了对过去输入信息处理的状况）。系统只需要根据**当前所处的状态**和**当前面临的输入信息**就可以决定系统的**后继行为**。每当系统处理的当前的输入后，系统的内部**状态也将发生改变**。
## 2.1. FA模型
![FA模型](./Picture/04.FA%E6%A8%A1%E5%9E%8B.png)
- 输入带（input tape）：用来存放输入符号串
- 读头（head）：从左向右逐个读取输入符号，不能修改，不能往返移动
- 有穷控制器（finite control）：具有有穷个状态数，根据**当前的状态**和**当前输入符号**控制转入**下一状态**。
### 2.1.1. FA的表示：转换图（Transition Graph）
![FA的转换图](./Picture/05.FA%E7%9A%84%E8%A3%85%E6%8D%A2%E5%9B%BE.png)
- 结点：FA的**状态**
    - 初始状态（开始状态）：只有一个，由**start箭头**指向
    - 终止状态（接收状态）：可以有多个，用**双圈**表示
- 带标记的**有向边**：如果对于输入a，存在一个从状态p到状态q的转换，就在p、q之间画一条有向边，并标记上a
### 2.1.2. FA定义（接收）的语言
- 给定输入串x，如果存在一个对应于串x的从**初始状态**到**某个终止状态**的转换序列，则称串x被该**FA接收**
    - 例，上图的转换图，输入串```abbaabb```，该串可以被FA接收
- 由一个有穷自动机M接收的所有串构成的集合称为是该**FA定义（或接收）的语言**，记为L(M)
    - 例，上图的转换图所表示的自动机，接收的语言是L(M) = 所有以```abb```结尾的字母表{a,b}上的串的集合
### 2.1.3. 最长字串匹配原则（Longest String Matching Principle)
- 当输入串的**多个前缀**与一个或多个模式匹配时，总是选择**最长的前缀**进行匹配
![](./Picture/06.%E6%9C%80%E9%95%BF%E5%AD%97%E4%B8%B2%E5%8C%B9%E9%85%8D%E5%8E%9F%E5%88%99%E7%A4%BA%E6%84%8F%E5%9B%BE.png)
- 在到达某个终态之后，只要输入带上还有符号，FA就继续前进，以便寻找尽可能长的匹配
## 2.2. FA的分类
- 确定的FA（Deterministic finite automata, DFA）
- 非确定的FA（Nondeterministic finite automata, NFA）
### 2.2.1. 确定的有穷自动机
$M = (S, Σ, δ, $$s_0$$, F)$
- S：**有穷状态集**
- Σ：**输入字母表**，即输入符号集合。假设ε不是Σ中的元素
- δ：将SxΣ映射到S的转换函数。
- $s_0$：**开始状态**或初始状态，$s_0$$\in$S
- F：**接收状态**或终止状态集合，F$\subseteq$S 

* 例：一个DFA
$M = (S, Σ, δ, $$s_0$$, F)$
![DFA示例](./Picture/07.DFA%E7%A4%BA%E4%BE%8B.png)
    - S：状态集合包含四个状态，{0,1,2,3}
    - Σ：{a,b}
    - δ：转换函数可以用一个转换表来表示
        |状态\输入|a|b|
        |:--:|:--:|:--:|
        |0|1|0|
        |1|1|2|
        |2|1|3|
        |3*|1|0|
### 2.2.2. 非确定的有穷自动机
$M = (S, Σ, δ, $$s_0$$, F)$
- S：**有穷状态集**
- Σ：**输入字母表**，即输入符号集合。假设ε不是Σ中的元素
- δ：将SxΣ映射到$2^S$的转换函数。
- $s_0$：**开始状态**或初始状态，$s_0$$\in$S
- F：**接收状态**或终止状态集合，F$\subseteq$S 
### DFA和NFA的等价性
- 对任何NFA N，存在识别同一语言的DFA D
- 对任何DFA D，存在识别统一语言的NFA N
![NFA和DFA等价性](./Picture/08.NFA%E5%92%8CDFA%E7%AD%89%E4%BB%B7%E6%80%A7.png)
上图的NFA和DFA接收的语言为```r = (a|b)*abb```
**正则表达式、正则文法和FA均是等价的**。